<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               xmlns:vm="clr-namespace:OpenUtauMobile.ViewModels.Controls"
               xmlns:res="clr-namespace:OpenUtauMobile.Resources.Strings"
                xmlns:converters="clr-namespace:OpenUtauMobile.ViewModels.Converters"
               Color="Transparent"
               x:Name="PopupSelectPhonemizer"
               x:Class="OpenUtauMobile.Views.Controls.SelectPhonemizerPopup">
    <toolkit:Popup.BindingContext>
        <vm:SelectPhonemizerPopupViewModel/>
    </toolkit:Popup.BindingContext>
    <toolkit:Popup.Resources>
        <converters:EqualityConverter x:Key="EqualityConverter" />
    </toolkit:Popup.Resources>

    <!-- 主体 -->
    <Border StrokeThickness="0"
            Background="{DynamicResource PopupBackground}"
            Padding="0"
            WidthRequest="400"
            StrokeShape="RoundRectangle 10">
        <Grid RowDefinitions="40, 400, 60">
            <!-- 标题栏 -->
            <Border BackgroundColor="#66CCFF" Padding="10,2,10,2">
                <Label x:Name="LabelTitle" Text="{Static res:AppResources.SelectPhonemizer}" FontSize="20" HorizontalTextAlignment="Start" VerticalTextAlignment="Center"/>
            </Border>
            <!-- 列表 -->
            <Border Grid.Row="1" StrokeShape="RoundRectangle 5" Margin="10">
                <Grid ColumnDefinitions="100,*">
                    <!-- 左栏分组 -->
                    <ScrollView Grid.Column="0" BackgroundColor="#20808080">
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding Groups}" x:Name="LayoutGroups">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Grid RowDefinitions="Auto, .5">
                                        <Button x:Name="ButtonSelectGroup" Clicked="ButtonSelectGroup_Clicked" BackgroundColor="Transparent"/>
                                        <Grid Grid.Row="0" ColumnDefinitions="5,*">
                                            <BoxView BackgroundColor="{DynamicResource Primary}">
                                                <BoxView.IsVisible>
                                                    <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                        <Binding Path="."/>
                                                        <Binding Source="{x:Reference PopupSelectPhonemizer}" Path="BindingContext.CurrentGroup" />
                                                    </MultiBinding>
                                                </BoxView.IsVisible>
                                            </BoxView>
                                            <Label Text="{Binding Value}" Grid.Column="1" VerticalTextAlignment="Center" Margin="5"/>
                                        </Grid>
                                        <BoxView Grid.Row="1" BackgroundColor="{DynamicResource ItemDivider}" />
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </ScrollView>
                    <!-- 右栏音素器 -->
                    <ScrollView Grid.Column="1">
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding PhonemizerFactories}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Grid RowDefinitions="Auto, .5">
                                        <Label Text="{Binding Value}" VerticalTextAlignment="Center" Margin="5"/>
                                        <Button BackgroundColor="Transparent" x:Name="ButtonSelectPhonemizer" Clicked="ButtonSelectPhonemizer_Clicked"/>
                                        <BoxView Grid.Row="1" BackgroundColor="{DynamicResource ItemDivider}" />
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </ScrollView>
                </Grid>

            </Border>
            <!-- 按钮栏 -->
            <HorizontalStackLayout Grid.Row="2" Margin="10" HorizontalOptions="End" Spacing="10">
                <Button Text="{Static res:AppResources.CancelText}" Clicked="OnCancelClicked" CornerRadius="25" WidthRequest="80" BackgroundColor="Transparent" TextColor="{DynamicResource Primary}"/>
            </HorizontalStackLayout>
        </Grid>
    </Border>
</toolkit:Popup>
